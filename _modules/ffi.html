<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ffi &#8212; beat 1.0beta documentation</title>
    <link rel="stylesheet" href="../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    
      <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto+Slab">
    
    
    <script type="text/javascript" src="../_static/jquery.gifplayer.js"></script>
    <link rel="stylesheet" type="text/css" href="../_static/gifplayer.css">
    <!-- Piwik -->
    <script type="text/javascript">
      var _paq = _paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//pyrocko.org/pwk/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <noscript>
    <img src="https://pyrocko.org/pwk/piwik.php?idsite=1&rec=1" style="border:0" alt="" />
    </noscript>

  </head>
  <body>

    <div class="related">
      <h3>Navigation</h3>
        <ul>
          <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
          <li>
            <img src='https://pyrocko.org/_static/pyrocko.svg' class='pyrocko-button' onclick="window.location = 'https://pyrocko.org';">
          </li>
           &#187;
          <li>
              <a href="../index.html">beat 1.0beta documentation</a> &#187;
          </li>
            <li><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
        </ul>
    </div>
    

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ffi</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">beat</span> <span class="k">import</span> <span class="n">heart</span>
<span class="kn">from</span> <span class="nn">beat</span> <span class="k">import</span> <span class="n">utility</span> <span class="k">as</span> <span class="n">ut</span>
<span class="kn">from</span> <span class="nn">beat.fast_sweeping</span> <span class="k">import</span> <span class="n">fast_sweep</span>
<span class="kn">from</span> <span class="nn">beat</span> <span class="k">import</span> <span class="n">parallel</span>
<span class="kn">from</span> <span class="nn">beat.config</span> <span class="k">import</span> <span class="n">SeismicGFLibraryConfig</span><span class="p">,</span> <span class="n">GeodeticGFLibraryConfig</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">RawArray</span>

<span class="kn">from</span> <span class="nn">pyrocko.trace</span> <span class="k">import</span> <span class="n">Trace</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">gf</span>
<span class="kn">from</span> <span class="nn">pyrocko.guts</span> <span class="k">import</span> <span class="n">load</span>

<span class="kn">from</span> <span class="nn">theano</span> <span class="k">import</span> <span class="n">shared</span>
<span class="kn">from</span> <span class="nn">theano</span> <span class="k">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">tconfig</span>
<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="k">as</span> <span class="nn">tt</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">num</span>


<span class="n">gf_dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span>

<span class="n">backends</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;numpy&#39;</span><span class="p">:</span> <span class="n">num</span><span class="p">,</span> <span class="s1">&#39;theano&#39;</span><span class="p">:</span> <span class="n">tt</span><span class="p">}</span>


<span class="n">km</span> <span class="o">=</span> <span class="mf">1000.</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ffi&#39;</span><span class="p">)</span>


<span class="n">PatchMap</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;PatchMap&#39;</span><span class="p">,</span> <span class="s1">&#39;count, slc, shp, npatches, indexmap&#39;</span><span class="p">)</span>


<span class="n">gf_entries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;durations&#39;</span><span class="p">,</span> <span class="s1">&#39;start_times&#39;</span><span class="p">,</span> <span class="s1">&#39;patches&#39;</span><span class="p">,</span> <span class="s1">&#39;targets&#39;</span><span class="p">]</span>


<span class="n">slip_directions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;uparr&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;slip&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39;rake&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>
    <span class="s1">&#39;uperp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;slip&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39;rake&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">90.</span><span class="p">},</span>
    <span class="s1">&#39;utensile&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;slip&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;rake&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;opening&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">}}</span>


<span class="k">def</span> <span class="nf">_init_shared</span><span class="p">(</span><span class="n">gfstofill</span><span class="p">,</span> <span class="n">tminstofill</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Accessing shared arrays!&#39;</span><span class="p">)</span>
    <span class="n">parallel</span><span class="o">.</span><span class="n">gfmatrix</span> <span class="o">=</span> <span class="n">gfstofill</span>
    <span class="n">parallel</span><span class="o">.</span><span class="n">tmins</span> <span class="o">=</span> <span class="n">tminstofill</span>


<span class="k">class</span> <span class="nc">GFLibraryError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="GFLibrary"><a class="viewcode-back" href="../api.html#ffi.GFLibrary">[docs]</a><span class="k">class</span> <span class="nc">GFLibrary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Baseclass for linear Greens Function Libraries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sgfmatrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patchidxs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack_switch</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_check_mode_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;theano&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sgfmatrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GFLibraryError</span><span class="p">(</span>
                    <span class="s1">&#39;To use &quot;stack_all&quot; theano stacking optimization mode&#39;</span>
                    <span class="s1">&#39; has to be initialised!&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GFLibraryError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Greens Function Library is not set up!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filesize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Size of the library in MByte.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="mf">8.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1024.</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">patchidxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patchidxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_patchidxs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npatches</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patchidxs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sw_patchidxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patchidxs</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s1">&#39;theano&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatchidxs</span>

    <span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.yaml&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Dumping GF config to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;beat.ffi.</span><span class="si">%s</span><span class="s1"> YAML Config&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">regularize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outpath</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot load config, file </span><span class="si">%s</span><span class="s1"> does not exist!&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

<div class="viewcode-block" id="GFLibrary.set_stack_mode"><a class="viewcode-back" href="../api.html#ffi.GFLibrary.set_stack_mode">[docs]</a>    <span class="k">def</span> <span class="nf">set_stack_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets mode on witch backend the stacking is working.</span>
<span class="sd">        Dependend on that the input to the stack function has to be</span>
<span class="sd">        either of :class:`numpy.ndarray` or of :class:`theano.tensor.Tensor`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mode : str</span>
<span class="sd">            on witch array to stack</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">available_modes</span> <span class="o">=</span> <span class="n">backends</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_modes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GFLibraryError</span><span class="p">(</span>
                <span class="s1">&#39;Stacking mode </span><span class="si">%s</span><span class="s1"> not available! &#39;</span>
                <span class="s1">&#39;Available modes: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">available_modes</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span></div></div>


<span class="k">def</span> <span class="nf">get_gf_prefix</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">wavename</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">wavename</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">)</span>


<div class="viewcode-block" id="load_gf_library"><a class="viewcode-back" href="../api.html#ffi.load_gf_library">[docs]</a><span class="k">def</span> <span class="nf">load_gf_library</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loading GF Library config and initialise memmaps for Traces and times.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">datatype</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;seismic&#39;</span><span class="p">:</span>
        <span class="n">gfs</span> <span class="o">=</span> <span class="n">SeismicGFLibrary</span><span class="p">()</span>
        <span class="n">gfs</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">inpath</span> <span class="o">+</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">)</span>
        <span class="n">gfs</span><span class="o">.</span><span class="n">_gfmatrix</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">inpath</span> <span class="o">+</span> <span class="s1">&#39;.traces.npy&#39;</span><span class="p">,</span>
            <span class="n">mmap_mode</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">),</span>
            <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">gfs</span><span class="o">.</span><span class="n">_tmins</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">inpath</span> <span class="o">+</span> <span class="s1">&#39;.times.npy&#39;</span><span class="p">,</span>
            <span class="n">mmap_mode</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">),</span>
            <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;geodetic&#39;</span><span class="p">:</span>
        <span class="n">gfs</span> <span class="o">=</span> <span class="n">GeodeticGFLibrary</span><span class="p">()</span>
        <span class="n">gfs</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">inpath</span> <span class="o">+</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">)</span>
        <span class="n">gfs</span><span class="o">.</span><span class="n">_gfmatrix</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">inpath</span> <span class="o">+</span> <span class="s1">&#39;.traces.npy&#39;</span><span class="p">,</span>
            <span class="n">mmap_mode</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">),</span>
            <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;datatype &quot;</span><span class="si">%s</span><span class="s1">&quot; not supported!&#39;</span> <span class="o">%</span> <span class="n">datatype</span><span class="p">)</span>

    <span class="n">gfs</span><span class="o">.</span><span class="n">_stack_switch</span><span class="p">[</span><span class="s1">&#39;numpy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gfs</span><span class="o">.</span><span class="n">_gfmatrix</span>
    <span class="k">return</span> <span class="n">gfs</span></div>


<div class="viewcode-block" id="GeodeticGFLibrary"><a class="viewcode-back" href="../api.html#ffi.GeodeticGFLibrary">[docs]</a><span class="k">class</span> <span class="nc">GeodeticGFLibrary</span><span class="p">(</span><span class="n">GFLibrary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Seismic Greens Funcion Library for the finite fault optimization.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : :class:`SeismicGFLibraryConfig`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">SeismicGFLibraryConfig</span><span class="p">()):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">GeodeticGFLibrary</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sgfmatrix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">Geodetic GF Library</span>
<span class="s1">------------------</span>
<span class="si">%s</span><span class="s1"></span>
<span class="s1">npatches: </span><span class="si">%i</span><span class="s1"></span>
<span class="s1">nsamples: </span><span class="si">%i</span><span class="s1"></span>
<span class="s1">size: </span><span class="si">%i</span><span class="s1"></span>
<span class="s1">filesize [MB]: </span><span class="si">%f</span><span class="s1"></span>
<span class="s1">filename: </span><span class="si">%s</span><span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dump</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npatches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesize</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="GeodeticGFLibrary.save"><a class="viewcode-back" href="../api.html#ffi.GeodeticGFLibrary.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save GFLibrary data and config file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dumping GF Library to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="n">num</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span> <span class="o">+</span> <span class="s1">&#39;.traces&#39;</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">npatches</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">allocate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="p">(</span><span class="n">npatches</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">allocate</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Allocating GF Library&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_stack_mode</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Setting </span><span class="si">%s</span><span class="s1"> GF Library to optimization mode.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sgfmatrix</span> <span class="o">=</span> <span class="n">shared</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">parallel</span><span class="o">.</span><span class="n">memshare</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spatchidxs</span> <span class="o">=</span> <span class="n">shared</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patchidxs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;geo_patchidx_vec&#39;</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stack_switch</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;numpy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span><span class="p">,</span>
            <span class="s1">&#39;theano&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sgfmatrix</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_stack_mode</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;theano&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="GeodeticGFLibrary.put"><a class="viewcode-back" href="../api.html#ffi.GeodeticGFLibrary.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill the GF Library with synthetic traces for one target and one patch.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        entries : 2d :class:`numpy.NdArray`</span>
<span class="sd">            of synthetic trace data samples, the waveforms</span>
<span class="sd">        patchidx : int</span>
<span class="sd">            index to patch (source) that is used to produce the synthetics</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Entries have to be 1d arrays!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">entries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GFLibraryError</span><span class="p">(</span>
                <span class="s1">&#39;Trace length of entries is not consistent with the library&#39;</span>
                <span class="s1">&#39; to be filled! Entries length: </span><span class="si">%i</span><span class="s1"> Library: </span><span class="si">%i</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">entries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_setup</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parallel</span><span class="p">,</span> <span class="s1">&#39;gfmatrix&#39;</span><span class="p">):</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">parallel</span><span class="o">.</span><span class="n">gfmatrix</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GFLibraryError</span><span class="p">(</span>
                <span class="s1">&#39;Neither shared nor standard GFLibrary is setup!&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span>

        <span class="n">matrix</span><span class="p">[</span><span class="n">patchidx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">entries</span></div>

<div class="viewcode-block" id="GeodeticGFLibrary.stack_all"><a class="viewcode-back" href="../api.html#ffi.GeodeticGFLibrary.stack_all">[docs]</a>    <span class="k">def</span> <span class="nf">stack_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slips</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stack all patches for all targets at once.</span>
<span class="sd">        In theano for efficient optimization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        matrix : size (nsamples)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_mode_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack_switch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">slips</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nsamples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">npatches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_gf_prefix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">component</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">crust_ind</span><span class="p">)</span></div>


<div class="viewcode-block" id="SeismicGFLibrary"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary">[docs]</a><span class="k">class</span> <span class="nc">SeismicGFLibrary</span><span class="p">(</span><span class="n">GFLibrary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Seismic Greens Funcion Library for the finite fault optimization.</span>

<span class="sd">    Eases inspection of Greens Functions through interface to the snuffler.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : :class:`SeismicGFLibraryConfig`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">SeismicGFLibraryConfig</span><span class="p">()):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SeismicGFLibrary</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sgfmatrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stmins</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">Seismic GF Library</span>
<span class="s1">------------------</span>
<span class="si">%s</span><span class="s1"></span>
<span class="s1">ntargets: </span><span class="si">%i</span><span class="s1"></span>
<span class="s1">npatches: </span><span class="si">%i</span><span class="s1"></span>
<span class="s1">ndurations: </span><span class="si">%i</span><span class="s1"></span>
<span class="s1">nstarttimes: </span><span class="si">%i</span><span class="s1"></span>
<span class="s1">nsamples: </span><span class="si">%i</span><span class="s1"></span>
<span class="s1">size: </span><span class="si">%i</span><span class="s1"></span>
<span class="s1">filesize [MB]: </span><span class="si">%f</span><span class="s1"></span>
<span class="s1">filename: </span><span class="si">%s</span><span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dump</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntargets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndurations</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nstarttimes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesize</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="SeismicGFLibrary.save"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save GFLibrary data and config file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dumping GF Library to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="n">num</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span> <span class="o">+</span> <span class="s1">&#39;.traces&#39;</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">num</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span> <span class="o">+</span> <span class="s1">&#39;.times&#39;</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmins</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">ntargets</span><span class="p">,</span> <span class="n">npatches</span><span class="p">,</span> <span class="n">ndurations</span><span class="p">,</span>
            <span class="n">nstarttimes</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">allocate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ntargets</span><span class="p">,</span> <span class="n">npatches</span><span class="p">,</span> <span class="n">ndurations</span><span class="p">,</span> <span class="n">nstarttimes</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">allocate</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Allocating GF Library&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmins</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ntargets</span><span class="p">,</span> <span class="n">npatches</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_stack_mode</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Setting </span><span class="si">%s</span><span class="s1"> GF Library to optimization mode.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sgfmatrix</span> <span class="o">=</span> <span class="n">shared</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">parallel</span><span class="o">.</span><span class="n">memshare</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stmins</span> <span class="o">=</span> <span class="n">shared</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmins</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;_tmins&#39;</span><span class="p">,</span>
            <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spatchidxs</span> <span class="o">=</span> <span class="n">shared</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patchidxs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;seis_patchidx_vec&#39;</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stack_switch</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;numpy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span><span class="p">,</span>
            <span class="s1">&#39;theano&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sgfmatrix</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_stack_mode</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;theano&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="SeismicGFLibrary.set_patch_time"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.set_patch_time">[docs]</a>    <span class="k">def</span> <span class="nf">set_patch_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetidx</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">,</span> <span class="n">tmin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill the GF Library with trace times for one target and one patch.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        targetidx : int</span>
<span class="sd">            index to target</span>
<span class="sd">        patchidx : int</span>
<span class="sd">            index to patch (source) that is assumed to be hypocenter</span>
<span class="sd">        tmin : float</span>
<span class="sd">            tmin of the trace(s) if the hypocenter was in the location of this</span>
<span class="sd">            patch</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parallel</span><span class="p">,</span> <span class="s1">&#39;tmins&#39;</span><span class="p">):</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">parallel</span><span class="o">.</span><span class="n">tmins</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntargets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatches</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GFLibraryError</span><span class="p">(</span>
                <span class="s1">&#39;Neither shared nor standard GFLibrary is setup!&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmins</span>

        <span class="n">times</span><span class="p">[</span><span class="n">targetidx</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmin</span></div>

<div class="viewcode-block" id="SeismicGFLibrary.put"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">targetidx</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">,</span>
            <span class="n">durations</span><span class="p">,</span> <span class="n">starttimes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill the GF Library with synthetic traces for one target and one patch.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        entries : 2d :class:`numpy.NdArray`</span>
<span class="sd">            of synthetic trace data samples, the waveforms</span>
<span class="sd">        targetidx : int</span>
<span class="sd">            index to target</span>
<span class="sd">        patchidx : int</span>
<span class="sd">            index to patch (source) that is used to produce the synthetics</span>
<span class="sd">        durationidxs : list or :class:`numpy.NdArray`</span>
<span class="sd">            of indexes to the respective duration of the STFs that have been</span>
<span class="sd">            used to create the synthetics</span>
<span class="sd">        starttimeidxs : list or :class:`numpy.NdArray`</span>
<span class="sd">            of indexes to the respective duration of the STFs that have been</span>
<span class="sd">            used to create the synthetics</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Entries have to be 2d arrays!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">entries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GFLibraryError</span><span class="p">(</span>
                <span class="s1">&#39;Trace length of entries is not consistent with the library&#39;</span>
                <span class="s1">&#39; to be filled! Entries length: </span><span class="si">%i</span><span class="s1"> Library: </span><span class="si">%i</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">entries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_setup</span><span class="p">()</span>

        <span class="n">durationidxs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">durations2idxs</span><span class="p">(</span><span class="n">durations</span><span class="p">)</span>
        <span class="n">starttimeidxs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">starttimes2idxs</span><span class="p">(</span><span class="n">starttimes</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parallel</span><span class="p">,</span> <span class="s1">&#39;gfmatrix&#39;</span><span class="p">):</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">parallel</span><span class="o">.</span><span class="n">gfmatrix</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GFLibraryError</span><span class="p">(</span>
                <span class="s1">&#39;Neither shared nor standard GFLibrary is setup!&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;targetidx </span><span class="si">%i</span><span class="s1">, patchidx </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">targetidx</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">))</span>

        <span class="n">matrix</span><span class="p">[</span><span class="n">targetidx</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">,</span> <span class="n">durationidxs</span><span class="p">,</span> <span class="n">starttimeidxs</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">entries</span></div>

<div class="viewcode-block" id="SeismicGFLibrary.trace_tmin"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.trace_tmin">[docs]</a>    <span class="k">def</span> <span class="nf">trace_tmin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetidx</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns trace time of single target with respect to hypocentral trace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmins</span><span class="p">[</span><span class="n">targetidx</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">])</span></div>

<div class="viewcode-block" id="SeismicGFLibrary.get_all_tmins"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.get_all_tmins">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_tmins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns tmins for all targets for specified hypocentral patch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s1">&#39;theano&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GFLibraryError</span><span class="p">(</span>
                    <span class="s1">&#39;To use &quot;get_all_tmins&quot; theano stacking optimization mode&#39;</span>
                    <span class="s1">&#39; has to be initialised!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stmins</span><span class="p">[:,</span> <span class="n">patchidx</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmins</span><span class="p">[:,</span> <span class="n">patchidx</span><span class="p">]</span></div>

<div class="viewcode-block" id="SeismicGFLibrary.starttimes2idxs"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.starttimes2idxs">[docs]</a>    <span class="k">def</span> <span class="nf">starttimes2idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">starttimes</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest_neighbor&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms starttimes into indexes to the GFLibrary.</span>
<span class="sd">        Depending on the stacking mode of the GFLibrary theano or numpy</span>
<span class="sd">        is used.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        starttimes [s]: :class:`numpy.ndarray` or :class:`theano.tensor.Tensor`</span>
<span class="sd">            of the rupturing of the patch, float</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        starttimeidxs, starttimes : :class:`numpy.ndarray` or</span>
<span class="sd">            :class:`theano.tensor.Tensor`, int16</span>
<span class="sd">            (output depends on interpolation scheme,</span>
<span class="sd">            if multilinear interpolation factors are returned as well)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;nearest_neighbor&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">backends</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                <span class="p">(</span><span class="n">starttimes</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">starttime_min</span><span class="p">)</span> <span class="o">/</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">starttime_sampling</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">),</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;multilinear&#39;</span><span class="p">:</span>
            <span class="n">dstarttimes</span> <span class="o">=</span> <span class="p">(</span><span class="n">starttimes</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">starttime_min</span><span class="p">)</span> <span class="o">/</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">starttime_sampling</span>
            <span class="n">ceil_starttimes</span> <span class="o">=</span> <span class="n">backends</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">]</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                <span class="n">dstarttimes</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span>
            <span class="n">factors</span> <span class="o">=</span> <span class="n">ceil_starttimes</span> <span class="o">-</span> <span class="n">dstarttimes</span>
            <span class="k">return</span> <span class="n">ceil_starttimes</span><span class="p">,</span> <span class="n">factors</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Interpolation scheme </span><span class="si">%s</span><span class="s1"> not implemented!&#39;</span> <span class="o">%</span> <span class="n">interpolation</span><span class="p">)</span></div>

<div class="viewcode-block" id="SeismicGFLibrary.idxs2durations"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.idxs2durations">[docs]</a>    <span class="k">def</span> <span class="nf">idxs2durations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idxs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map index to durations [s]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">idxs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration_sampling</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration_min</span></div>

<div class="viewcode-block" id="SeismicGFLibrary.idxs2starttimes"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.idxs2starttimes">[docs]</a>    <span class="k">def</span> <span class="nf">idxs2starttimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idxs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map index to durations [s]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">idxs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">starttime_sampling</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">starttime_min</span></div>

<div class="viewcode-block" id="SeismicGFLibrary.durations2idxs"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.durations2idxs">[docs]</a>    <span class="k">def</span> <span class="nf">durations2idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">durations</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest_neighbor&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms durations into indexes to the GFLibrary.</span>
<span class="sd">        Depending on the stacking mode of the GFLibrary theano or numpy</span>
<span class="sd">        is used.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        durations [s] : :class:`numpy.ndarray` or :class:`theano.tensor.Tensor`</span>
<span class="sd">            of the rupturing of the patch, float</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        durationidxs, starttimes : :class:`numpy.ndarray` or</span>
<span class="sd">            :class:`theano.tensor.Tensor`, int16</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;nearest_neighbor&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">backends</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                <span class="p">(</span><span class="n">durations</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration_min</span><span class="p">)</span> <span class="o">/</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duration_sampling</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">),</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;multilinear&#39;</span><span class="p">:</span>
            <span class="n">ddurations</span> <span class="o">=</span> <span class="p">(</span><span class="n">durations</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration_min</span><span class="p">)</span> <span class="o">/</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">duration_sampling</span>
            <span class="n">ceil_durations</span> <span class="o">=</span> <span class="n">backends</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">]</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                <span class="n">ddurations</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span>
            <span class="n">factors</span> <span class="o">=</span> <span class="n">ceil_durations</span> <span class="o">-</span> <span class="n">ddurations</span>
            <span class="k">return</span> <span class="n">ceil_durations</span><span class="p">,</span> <span class="n">factors</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Interpolation scheme </span><span class="si">%s</span><span class="s1"> not implemented!&#39;</span> <span class="o">%</span> <span class="n">interpolation</span><span class="p">)</span></div>

<div class="viewcode-block" id="SeismicGFLibrary.stack"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.stack">[docs]</a>    <span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetidx</span><span class="p">,</span> <span class="n">patchidxs</span><span class="p">,</span> <span class="n">durationidxs</span><span class="p">,</span> <span class="n">starttimeidxs</span><span class="p">,</span> <span class="n">slips</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stack selected traces from the GF Library of specified</span>
<span class="sd">        target, patch, durations and starttimes. Numpy or theano dependend</span>
<span class="sd">        on the stack_mode</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` or of :class:`theano.tensor.Tensor` dependend</span>
<span class="sd">        on stack mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack_switch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">][</span>
            <span class="n">targetidx</span><span class="p">,</span> <span class="n">patchidxs</span><span class="p">,</span> <span class="n">durationidxs</span><span class="p">,</span> <span class="n">starttimeidxs</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="p">(</span><span class="n">slips</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">slips</span><span class="p">)</span></div>

<div class="viewcode-block" id="SeismicGFLibrary.stack_all"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.stack_all">[docs]</a>    <span class="k">def</span> <span class="nf">stack_all</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">durations</span><span class="p">,</span> <span class="n">starttimes</span><span class="p">,</span> <span class="n">slips</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest_neighbor&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stack all patches for all targets at once.</span>
<span class="sd">        In theano for efficient optimization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        matrix : size (ntargets, nsamples)</span>
<span class="sd">        option : tensor.batched_dot(sd.dimshuffle((1,0,2)), u).sum(axis=0)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_mode_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>

        <span class="n">durationidxs</span><span class="p">,</span> <span class="n">rt_factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">durations2idxs</span><span class="p">(</span>
            <span class="n">durations</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>
        <span class="n">starttimeidxs</span><span class="p">,</span> <span class="n">st_factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">starttimes2idxs</span><span class="p">(</span>
            <span class="n">starttimes</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;nearest_neighbor&#39;</span><span class="p">:</span>

            <span class="n">nslips</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">cd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack_switch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">][</span>
                <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sw_patchidxs</span><span class="p">,</span>
                <span class="n">durationidxs</span><span class="p">,</span> <span class="n">starttimeidxs</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntargets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">))</span>
            <span class="n">cslips</span> <span class="o">=</span> <span class="n">slips</span>

        <span class="k">elif</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;multilinear&#39;</span><span class="p">:</span>

            <span class="n">nslips</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">d_st_ceil_rt_ceil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack_switch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">][</span>
                <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sw_patchidxs</span><span class="p">,</span>
                <span class="n">durationidxs</span><span class="p">,</span> <span class="n">starttimeidxs</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntargets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">))</span>
            <span class="n">d_st_floor_rt_ceil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack_switch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">][</span>
                <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sw_patchidxs</span><span class="p">,</span>
                <span class="n">durationidxs</span><span class="p">,</span> <span class="n">starttimeidxs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntargets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">))</span>
            <span class="n">d_st_ceil_rt_floor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack_switch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">][</span>
                <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sw_patchidxs</span><span class="p">,</span>
                <span class="n">durationidxs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">starttimeidxs</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntargets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">))</span>
            <span class="n">d_st_floor_rt_floor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack_switch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">][</span>
                <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sw_patchidxs</span><span class="p">,</span>
                <span class="n">durationidxs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">starttimeidxs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntargets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">))</span>

            <span class="n">s_st_ceil_rt_ceil</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">st_factors</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rt_factors</span><span class="p">)</span> <span class="o">*</span> <span class="n">slips</span>
            <span class="n">s_st_floor_rt_ceil</span> <span class="o">=</span> <span class="n">st_factors</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">rt_factors</span><span class="p">)</span> <span class="o">*</span> <span class="n">slips</span>
            <span class="n">s_st_ceil_rt_floor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">st_factors</span><span class="p">)</span> <span class="o">*</span> <span class="n">rt_factors</span> <span class="o">*</span> <span class="n">slips</span>
            <span class="n">s_st_floor_rt_floor</span> <span class="o">=</span> <span class="n">st_factors</span> <span class="o">*</span> <span class="n">rt_factors</span> <span class="o">*</span> <span class="n">slips</span>

            <span class="n">cd</span> <span class="o">=</span> <span class="n">backends</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">]</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">d_st_ceil_rt_ceil</span><span class="p">,</span> <span class="n">d_st_floor_rt_ceil</span><span class="p">,</span>
                 <span class="n">d_st_ceil_rt_floor</span><span class="p">,</span> <span class="n">d_st_floor_rt_floor</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cslips</span> <span class="o">=</span> <span class="n">backends</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">]</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">s_st_ceil_rt_ceil</span><span class="p">,</span> <span class="n">s_st_floor_rt_ceil</span><span class="p">,</span>
                 <span class="n">s_st_ceil_rt_floor</span><span class="p">,</span> <span class="n">s_st_floor_rt_floor</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Interpolation scheme </span><span class="si">%s</span><span class="s1"> not implemented!&#39;</span> <span class="o">%</span> <span class="n">interpolation</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s1">&#39;theano&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tt</span><span class="o">.</span><span class="n">batched_dot</span><span class="p">(</span>
                <span class="n">cd</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">cslips</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="n">u2d</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                <span class="n">cslips</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatches</span> <span class="o">*</span> <span class="n">nslips</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk-&gt;ik&#39;</span><span class="p">,</span> <span class="n">cd</span> <span class="o">*</span> <span class="n">u2d</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>

<div class="viewcode-block" id="SeismicGFLibrary.get_traces"><a class="viewcode-back" href="../api.html#ffi.SeismicGFLibrary.get_traces">[docs]</a>    <span class="k">def</span> <span class="nf">get_traces</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">targetidxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">patchidxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">durationidxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">starttimeidxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return traces for specified indexes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">targetidx</span> <span class="ow">in</span> <span class="n">targetidxs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">patchidx</span> <span class="ow">in</span> <span class="n">patchidxs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">durationidx</span> <span class="ow">in</span> <span class="n">durationidxs</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">starttimeidx</span> <span class="ow">in</span> <span class="n">starttimeidxs</span><span class="p">:</span>
                        <span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gfmatrix</span><span class="p">[</span>
                            <span class="n">targetidx</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">,</span> <span class="n">durationidx</span><span class="p">,</span> <span class="n">starttimeidx</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="n">tr</span> <span class="o">=</span> <span class="n">Trace</span><span class="p">(</span>
                            <span class="n">ydata</span><span class="o">=</span><span class="n">ydata</span><span class="p">,</span>
                            <span class="n">deltat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span>
                            <span class="n">network</span><span class="o">=</span><span class="s1">&#39;target_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">targetidx</span><span class="p">,</span>
                            <span class="n">station</span><span class="o">=</span><span class="s1">&#39;patch_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">patchidx</span><span class="p">,</span>
                            <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;tau_</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">idxs2durations</span><span class="p">(</span>
                                <span class="n">durationidx</span><span class="p">),</span>
                            <span class="n">location</span><span class="o">=</span><span class="s1">&#39;t0_</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">idxs2starttimes</span><span class="p">(</span>
                                <span class="n">starttimeidx</span><span class="p">),</span>
                            <span class="n">tmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_tmin</span><span class="p">(</span><span class="n">targetidx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">traces</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reference_times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmins</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">deltat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wave_config</span><span class="o">.</span><span class="n">arrival_taper</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> \
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nstations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ntargets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">npatches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndurations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nstarttimes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nsamples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">starttime_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">scalar2floatX</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">starttime_sampling</span><span class="p">,</span> <span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">duration_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">scalar2floatX</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">duration_sampling</span><span class="p">,</span> <span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">duration_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">scalar2floatX</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">duration_min</span><span class="p">,</span> <span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">starttime_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">scalar2floatX</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">starttime_min</span><span class="p">,</span> <span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_gf_prefix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">component</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wave_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">crust_ind</span><span class="p">)</span></div>


<div class="viewcode-block" id="FaultOrdering"><a class="viewcode-back" href="../api.html#ffi.FaultOrdering">[docs]</a><span class="k">class</span> <span class="nc">FaultOrdering</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A mapping of source patches to the arrays of optimization results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    npls : list</span>
<span class="sd">        of number of patches in strike-direction</span>
<span class="sd">    npws : list</span>
<span class="sd">        of number of patches in dip-direction</span>
<span class="sd">    patch_size_strike : float</span>
<span class="sd">        patch size in strike-direction [km]</span>
<span class="sd">    patch_size_dip : float</span>
<span class="sd">        patch size in dip-direction [km]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npls</span><span class="p">,</span> <span class="n">npws</span><span class="p">,</span> <span class="n">patch_size_strike</span><span class="p">,</span> <span class="n">patch_size_dip</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">patch_size_dip</span> <span class="o">=</span> <span class="n">patch_size_dip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch_size_strike</span> <span class="o">=</span> <span class="n">patch_size_strike</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">npl</span><span class="p">,</span> <span class="n">npw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">npls</span><span class="p">,</span> <span class="n">npws</span><span class="p">):</span>
            <span class="n">npatches</span> <span class="o">=</span> <span class="n">npl</span> <span class="o">*</span> <span class="n">npw</span>
            <span class="n">slc</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">npatches</span><span class="p">)</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="p">(</span><span class="n">npw</span><span class="p">,</span> <span class="n">npl</span><span class="p">)</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npatches</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PatchMap</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">slc</span><span class="p">,</span> <span class="n">shp</span><span class="p">,</span> <span class="n">npatches</span><span class="p">,</span> <span class="n">indexes</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shared</span><span class="p">(</span>
                <span class="n">indexes</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;patchidx_array_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">,</span>
                <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">))</span>
            <span class="n">dim</span> <span class="o">+=</span> <span class="n">npatches</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">npatches</span> <span class="o">=</span> <span class="n">dim</span></div>


<span class="k">class</span> <span class="nc">FaultGeometryError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="positions2idxs"><a class="viewcode-back" href="../api.html#ffi.positions2idxs">[docs]</a><span class="k">def</span> <span class="nf">positions2idxs</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">cell_size</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return index to a grid with a given cell size.npatches</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    positions : :class:`numpy.NdArray` float</span>
<span class="sd">        of positions [km]</span>
<span class="sd">    cell_size : float</span>
<span class="sd">        size of grid cells</span>
<span class="sd">    backend : str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">available_backends</span> <span class="o">=</span> <span class="n">backends</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_backends</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Backend not supported! Options: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">available_backends</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">backends</span><span class="p">[</span><span class="n">backend</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">positions</span> <span class="o">-</span> <span class="p">(</span>
        <span class="n">cell_size</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span> <span class="o">/</span> <span class="n">cell_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FaultGeometry"><a class="viewcode-back" href="../api.html#ffi.FaultGeometry">[docs]</a><span class="k">class</span> <span class="nc">FaultGeometry</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">seismosizer</span><span class="o">.</span><span class="n">Cloneable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object to construct complex fault-geometries with several subfaults.</span>
<span class="sd">    Stores information for subfault geometries and</span>
<span class="sd">    inversion variables (e.g. slip-components).</span>
<span class="sd">    Yields patch objects for requested subfault, dataset and component.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datatypes : list</span>
<span class="sd">        of str of potential dataset fault geometries to be stored</span>
<span class="sd">    components : list</span>
<span class="sd">        of str of potential inversion variables (e.g. slip-components) to</span>
<span class="sd">        be stored</span>
<span class="sd">    ordering : :class:`FaultOrdering`</span>
<span class="sd">        comprises patch information related to subfaults</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatypes</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">ordering</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datatypes</span> <span class="o">=</span> <span class="n">datatypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="n">components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ext_sources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span> <span class="o">=</span> <span class="n">ordering</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">Complex Fault Geometry</span>
<span class="s1">number of subfaults: </span><span class="si">%i</span><span class="s1"></span>
<span class="s1">number of patches: </span><span class="si">%i</span><span class="s1"> &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nsubfaults</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npatches</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_check_datatype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatype</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatypes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;Datatype &quot;</span><span class="si">%s</span><span class="s1">&quot; not included in FaultGeometry&#39;</span> <span class="o">%</span> <span class="n">datatype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">component</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Component not included in FaultGeometry&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsubfaults</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Subfault with index </span><span class="si">%i</span><span class="s1"> not defined!&#39;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_subfault_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">datatype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_datatype</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">component</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">datatype</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">component</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_subfaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">ext_sources</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_datatype</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_sources</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsubfaults</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FaultGeometryError</span><span class="p">(</span><span class="s1">&#39;Setup does not match fault ordering!&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ext_sources</span><span class="p">):</span>
            <span class="n">source_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault_key</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">source_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext_sources</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">replace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ext_sources</span><span class="p">[</span><span class="n">source_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FaultGeometryError</span><span class="p">(</span>
                    <span class="s1">&#39;Subfault already specified in geometry!&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_assign_datatype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatype</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datatype</span>

    <span class="k">def</span> <span class="nf">_assign_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">component</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">component</span>

<div class="viewcode-block" id="FaultGeometry.iter_subfaults"><a class="viewcode-back" href="../api.html#ffi.FaultGeometry.iter_subfaults">[docs]</a>    <span class="k">def</span> <span class="nf">iter_subfaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterator over subfaults.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_datatype</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsubfaults</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">get_subfault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_datatype</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

        <span class="n">source_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault_key</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">source_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext_sources</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext_sources</span><span class="p">[</span><span class="n">source_key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FaultGeometryError</span><span class="p">(</span><span class="s1">&#39;Requested subfault not defined!&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="FaultGeometry.get_subfault_patches"><a class="viewcode-back" href="../api.html#ffi.FaultGeometry.get_subfault_patches">[docs]</a>    <span class="k">def</span> <span class="nf">get_subfault_patches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all Patches to a subfault in the geometry.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            to subfault</span>
<span class="sd">        datatype : str</span>
<span class="sd">            to return &#39;seismic&#39; or &#39;geodetic&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="n">datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_datatype</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

        <span class="n">subfault</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault</span><span class="p">(</span>
            <span class="n">index</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">)</span>
        <span class="n">npw</span><span class="p">,</span> <span class="n">npl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault_discretization</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">subfault</span><span class="o">.</span><span class="n">patches</span><span class="p">(</span><span class="n">nl</span><span class="o">=</span><span class="n">npl</span><span class="p">,</span> <span class="n">nw</span><span class="o">=</span><span class="n">npw</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">get_all_patches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all RectangularSource patches for the full complex fault.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        datatype : str</span>
<span class="sd">            &#39;geodetic&#39; or &#39;seismic&#39;</span>
<span class="sd">        component : str</span>
<span class="sd">            slip component to return may be %s</span>
<span class="sd">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">slip_directions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_datatype</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

        <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsubfaults</span><span class="p">):</span>
            <span class="n">patches</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault_patches</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">patches</span>

<div class="viewcode-block" id="FaultGeometry.get_patch_indexes"><a class="viewcode-back" href="../api.html#ffi.FaultGeometry.get_patch_indexes">[docs]</a>    <span class="k">def</span> <span class="nf">get_patch_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return indexes for sub-fault patches that translate to the solution</span>
<span class="sd">        array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            to the sub-fault</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        slice : slice</span>
<span class="sd">            to the solution array that is being extracted from the related</span>
<span class="sd">            :class:`pymc3.backends.base.MultiTrace`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">vmap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">slc</span></div>

<div class="viewcode-block" id="FaultGeometry.get_subfault_discretization"><a class="viewcode-back" href="../api.html#ffi.FaultGeometry.get_subfault_discretization">[docs]</a>    <span class="k">def</span> <span class="nf">get_subfault_discretization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return number of patches in strike and dip-directions of a subfault.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            index to the subfault</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple (dip, strike)</span>
<span class="sd">            number of patches in fault direction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">vmap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">shp</span></div>

<div class="viewcode-block" id="FaultGeometry.point2starttimes"><a class="viewcode-back" href="../api.html#ffi.FaultGeometry.point2starttimes">[docs]</a>    <span class="k">def</span> <span class="nf">point2starttimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate starttimes for point in solution space.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nuc_dip</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s1">&#39;nucleation_dip&#39;</span><span class="p">]</span>
        <span class="n">nuc_strike</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s1">&#39;nucleation_strike&#39;</span><span class="p">]</span>
        <span class="n">velocities</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s1">&#39;velocities&#39;</span><span class="p">]</span>

        <span class="n">nuc_dip_idx</span><span class="p">,</span> <span class="n">nuc_strike_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fault_locations2idxs</span><span class="p">(</span>
            <span class="n">nuc_dip</span><span class="p">,</span> <span class="n">nuc_strike</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault_starttimes</span><span class="p">(</span>
            <span class="n">index</span><span class="p">,</span> <span class="n">velocities</span><span class="p">,</span> <span class="n">nuc_dip_idx</span><span class="p">,</span> <span class="n">nuc_strike_idx</span><span class="p">)</span></div>

<div class="viewcode-block" id="FaultGeometry.get_subfault_starttimes"><a class="viewcode-back" href="../api.html#ffi.FaultGeometry.get_subfault_starttimes">[docs]</a>    <span class="k">def</span> <span class="nf">get_subfault_starttimes</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rupture_velocities</span><span class="p">,</span> <span class="n">nuc_dip_idx</span><span class="p">,</span> <span class="n">nuc_strike_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get maximum bound of start times of extending rupture along</span>
<span class="sd">        the sub-fault.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            index to the subfault</span>
<span class="sd">        rupture_velocities : :class:`numpy.NdArray`</span>
<span class="sd">            of rupture velocities for each patch, (N x 1) for N patches [km/s]</span>
<span class="sd">        nuc_dip_idx : int</span>
<span class="sd">            rupture nucleation idx to patch in dip-direction</span>
<span class="sd">        nuc_strike_idx : int</span>
<span class="sd">            rupture nucleation idx to patch in strike-direction</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">npw</span><span class="p">,</span> <span class="n">npl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault_discretization</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">slownesses</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">rupture_velocities</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">npw</span><span class="p">,</span> <span class="n">npl</span><span class="p">))</span>

        <span class="n">start_times</span> <span class="o">=</span> <span class="n">fast_sweep</span><span class="o">.</span><span class="n">get_rupture_times_numpy</span><span class="p">(</span>
            <span class="n">slownesses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">patch_size_dip</span><span class="p">,</span>
            <span class="n">n_patch_strike</span><span class="o">=</span><span class="n">npl</span><span class="p">,</span> <span class="n">n_patch_dip</span><span class="o">=</span><span class="n">npw</span><span class="p">,</span>
            <span class="n">nuc_x</span><span class="o">=</span><span class="n">nuc_strike_idx</span><span class="p">,</span> <span class="n">nuc_y</span><span class="o">=</span><span class="n">nuc_dip_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">start_times</span></div>

<div class="viewcode-block" id="FaultGeometry.get_subfault_smoothing_operator"><a class="viewcode-back" href="../api.html#ffi.FaultGeometry.get_subfault_smoothing_operator">[docs]</a>    <span class="k">def</span> <span class="nf">get_subfault_smoothing_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get second order Laplacian smoothing operator.</span>

<span class="sd">        This is beeing used to smooth the slip-distribution</span>
<span class="sd">        in the optimization.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.Ndarray`</span>
<span class="sd">            (n_patch_strike + n_patch_dip) x (n_patch_strike + n_patch_dip)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">npw</span><span class="p">,</span> <span class="n">npl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subfault_discretization</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_smoothing_operator</span><span class="p">(</span>
            <span class="n">n_patch_strike</span><span class="o">=</span><span class="n">npl</span><span class="p">,</span>
            <span class="n">n_patch_dip</span><span class="o">=</span><span class="n">npw</span><span class="p">,</span>
            <span class="n">patch_size_strike</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">patch_size_strike</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
            <span class="n">patch_size_dip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">patch_size_dip</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span></div>

<div class="viewcode-block" id="FaultGeometry.fault_locations2idxs"><a class="viewcode-back" href="../api.html#ffi.FaultGeometry.fault_locations2idxs">[docs]</a>    <span class="k">def</span> <span class="nf">fault_locations2idxs</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">positions_dip</span><span class="p">,</span> <span class="n">positions_strike</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return patch indexes for given location on the fault.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions_dip : :class:`numpy.NdArray` float</span>
<span class="sd">            of positions in dip direction of the fault [km]</span>
<span class="sd">        positions_strike : :class:`numpy.NdArray` float</span>
<span class="sd">            of positions in strike direction of the fault [km]</span>
<span class="sd">        backend : str</span>
<span class="sd">            which implementation backend to use [numpy/theano]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dipidx</span> <span class="o">=</span> <span class="n">positions2idxs</span><span class="p">(</span>
            <span class="n">positions</span><span class="o">=</span><span class="n">positions_dip</span><span class="p">,</span>
            <span class="n">cell_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">patch_size_dip</span><span class="p">,</span>
            <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>
        <span class="n">strikeidx</span> <span class="o">=</span> <span class="n">positions2idxs</span><span class="p">(</span>
            <span class="n">positions</span><span class="o">=</span><span class="n">positions_strike</span><span class="p">,</span>
            <span class="n">cell_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">patch_size_strike</span><span class="p">,</span>
            <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dipidx</span><span class="p">,</span> <span class="n">strikeidx</span></div>

<div class="viewcode-block" id="FaultGeometry.patchmap"><a class="viewcode-back" href="../api.html#ffi.FaultGeometry.patchmap">[docs]</a>    <span class="k">def</span> <span class="nf">patchmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">dipidx</span><span class="p">,</span> <span class="n">strikeidx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return mapping of strike and dip indexes to patch index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">vmap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">indexmap</span><span class="p">[</span><span class="n">dipidx</span><span class="p">,</span> <span class="n">strikeidx</span><span class="p">]</span></div>

<div class="viewcode-block" id="FaultGeometry.spatchmap"><a class="viewcode-back" href="../api.html#ffi.FaultGeometry.spatchmap">[docs]</a>    <span class="k">def</span> <span class="nf">spatchmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">dipidx</span><span class="p">,</span> <span class="n">strikeidx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return mapping of strike and dip indexes to patch index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">smap</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">dipidx</span><span class="p">,</span> <span class="n">strikeidx</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nsubfaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">vmap</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">npatches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">npatches</span></div>


<div class="viewcode-block" id="discretize_sources"><a class="viewcode-back" href="../api.html#ffi.discretize_sources">[docs]</a><span class="k">def</span> <span class="nf">discretize_sources</span><span class="p">(</span>
        <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extension_width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">extension_length</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">patch_width</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">patch_length</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">datatypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geodetic&#39;</span><span class="p">],</span>
        <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build complex discretized fault.</span>

<span class="sd">    Extend sources into all directions and discretize sources into patches.</span>
<span class="sd">    Rounds dimensions to have no half-patches.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sources : :class:`sources.RectangularSource`</span>
<span class="sd">        Reference plane, which is being extended and</span>
<span class="sd">    extension_width : float</span>
<span class="sd">        factor to extend source in width (dip-direction)</span>
<span class="sd">    extension_length : float</span>
<span class="sd">        factor extend source in length (strike-direction)</span>
<span class="sd">    patch_width : float</span>
<span class="sd">        Width [km] of subpatch in dip-direction</span>
<span class="sd">    patch_length : float</span>
<span class="sd">        Length [km] of subpatch in strike-direction</span>
<span class="sd">    varnames : list</span>
<span class="sd">        of str with variable names that are being optimized for</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:&#39;FaultGeometry&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;seismic&#39;</span> <span class="ow">in</span> <span class="n">datatypes</span> <span class="ow">and</span> <span class="n">patch_length</span> <span class="o">!=</span> <span class="n">patch_width</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Seismic kinematic fault optimization does only support&#39;</span>
            <span class="s1">&#39; square patches (yet)! Please adjust the discretization!&#39;</span><span class="p">)</span>

    <span class="n">nsources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;seismic&#39;</span> <span class="ow">in</span> <span class="n">datatypes</span> <span class="ow">and</span> <span class="n">nsources</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Seismic kinematic fault optimization does&#39;</span>
            <span class="s1">&#39; only support one main fault (TODO fast&#39;</span>
            <span class="s1">&#39; sweeping across sub-faults)!&#39;</span>
            <span class="s1">&#39; nsources defined: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nsources</span><span class="p">)</span>

    <span class="n">patch_length_m</span> <span class="o">=</span> <span class="n">patch_length</span> <span class="o">*</span> <span class="n">km</span>
    <span class="n">patch_width_m</span> <span class="o">=</span> <span class="n">patch_width</span> <span class="o">*</span> <span class="n">km</span>

    <span class="n">npls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">npws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">ext_source</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">extent_source</span><span class="p">(</span>
            <span class="n">extension_width</span><span class="p">,</span> <span class="n">extension_length</span><span class="p">,</span>
            <span class="n">patch_width_m</span><span class="p">,</span> <span class="n">patch_length_m</span><span class="p">)</span>

        <span class="n">npls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ext_source</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="n">patch_length_m</span><span class="p">)))</span>
        <span class="n">npws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ext_source</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">patch_width_m</span><span class="p">)))</span>

    <span class="n">ordering</span> <span class="o">=</span> <span class="n">FaultOrdering</span><span class="p">(</span>
        <span class="n">npls</span><span class="p">,</span> <span class="n">npws</span><span class="p">,</span> <span class="n">patch_size_strike</span><span class="o">=</span><span class="n">patch_length</span><span class="p">,</span> <span class="n">patch_size_dip</span><span class="o">=</span><span class="n">patch_width</span><span class="p">)</span>

    <span class="n">fault</span> <span class="o">=</span> <span class="n">FaultGeometry</span><span class="p">(</span><span class="n">datatypes</span><span class="p">,</span> <span class="n">varnames</span><span class="p">,</span> <span class="n">ordering</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="n">datatypes</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Discretizing </span><span class="si">%s</span><span class="s1"> source(s)&#39;</span> <span class="o">%</span> <span class="n">datatype</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> slip component&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">)</span>
            <span class="n">param_mod</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">slip_directions</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>

            <span class="n">ext_sources</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="n">param_mod</span><span class="p">[</span><span class="s1">&#39;rake&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">rake</span>
                <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">param_mod</span><span class="p">)</span>

                <span class="n">ext_source</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">extent_source</span><span class="p">(</span>
                    <span class="n">extension_width</span><span class="p">,</span> <span class="n">extension_length</span><span class="p">,</span>
                    <span class="n">patch_width_m</span><span class="p">,</span> <span class="n">patch_length_m</span><span class="p">)</span>

                <span class="n">npls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ext_source</span><span class="o">.</span><span class="n">get_n_patches</span><span class="p">(</span><span class="n">patch_length_m</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">))</span>
                <span class="n">npws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ext_source</span><span class="o">.</span><span class="n">get_n_patches</span><span class="p">(</span><span class="n">patch_width_m</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">))</span>
                <span class="n">ext_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ext_source</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extended fault(s): </span><span class="se">\n</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ext_source</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>

            <span class="n">fault</span><span class="o">.</span><span class="n">setup_subfaults</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">ext_sources</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fault</span></div>


<span class="k">def</span> <span class="nf">_process_patch_geodetic</span><span class="p">(</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">gfs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">,</span> <span class="n">los_vectors</span><span class="p">,</span> <span class="n">odws</span><span class="p">):</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Patch Number </span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calculating synthetics ...&#39;</span><span class="p">)</span>
    <span class="n">disp</span> <span class="o">=</span> <span class="n">heart</span><span class="o">.</span><span class="n">geo_synthetics</span><span class="p">(</span>
        <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
        <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">patch</span><span class="p">],</span>
        <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;stacked_array&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Applying LOS vector ...&#39;</span><span class="p">)</span>
    <span class="n">los_disp</span> <span class="o">=</span> <span class="p">(</span><span class="n">disp</span> <span class="o">*</span> <span class="n">los_vectors</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">odws</span>

    <span class="n">gfs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">entries</span><span class="o">=</span><span class="n">los_disp</span><span class="p">,</span> <span class="n">patchidx</span><span class="o">=</span><span class="n">patchidx</span><span class="p">)</span>


<div class="viewcode-block" id="geo_construct_gf_linear"><a class="viewcode-back" href="../api.html#ffi.geo_construct_gf_linear">[docs]</a><span class="k">def</span> <span class="nf">geo_construct_gf_linear</span><span class="p">(</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">outdirectory</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nworkers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create geodetic Greens Function matrix for defined source geometry.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">        main path to directory containing the different Greensfunction stores</span>
<span class="sd">    outpath : str</span>
<span class="sd">        absolute path to the directory and filename where to store the</span>
<span class="sd">        Green&#39;s Functions</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        of index of Greens Function store to use</span>
<span class="sd">    datasets : list</span>
<span class="sd">        of :class:`heart.GeodeticDataset` for which the GFs are calculated</span>
<span class="sd">    targets : list</span>
<span class="sd">        of :class:`heart.GeodeticDataset`</span>
<span class="sd">    fault : :class:`FaultGeometry`</span>
<span class="sd">        fault object that may comprise of several sub-faults. thus forming a</span>
<span class="sd">        complex fault-geometry</span>
<span class="sd">    varnames : list</span>
<span class="sd">        of str with variable names that are being optimized for</span>
<span class="sd">    force : bool</span>
<span class="sd">        Force to overwrite existing files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">los_vectors</span><span class="p">,</span> <span class="n">odws</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">heart</span><span class="o">.</span><span class="n">concatenate_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>

    <span class="n">nsamples</span> <span class="o">=</span> <span class="n">odws</span><span class="o">.</span><span class="n">size</span>
    <span class="n">npatches</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">npatches</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">%i</span><span class="s1"> workers ...&#39;</span> <span class="o">%</span> <span class="n">nworkers</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;For slip component: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">)</span>

        <span class="n">gfl_config</span> <span class="o">=</span> <span class="n">GeodeticGFLibraryConfig</span><span class="p">(</span>
            <span class="n">component</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
            <span class="n">dimensions</span><span class="o">=</span><span class="p">(</span><span class="n">npatches</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span>
            <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
            <span class="n">crust_ind</span><span class="o">=</span><span class="n">crust_ind</span><span class="p">,</span>
            <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;geodetic&#39;</span><span class="p">)</span>
        <span class="n">gfs</span> <span class="o">=</span> <span class="n">GeodeticGFLibrary</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">gfl_config</span><span class="p">)</span>

        <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdirectory</span><span class="p">,</span> <span class="n">gfs</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.npz&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Library exists: </span><span class="si">%s</span><span class="s1">. &#39;</span>
                <span class="s1">&#39;Please use --force to override!&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nworkers</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">allocate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">allocate</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">gfs</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">npatches</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">allocate</span><span class="o">=</span><span class="n">allocate</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Setting up Green&#39;s Function Library: </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">gfs</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>

            <span class="n">parallel</span><span class="o">.</span><span class="n">check_available_memory</span><span class="p">(</span><span class="n">gfs</span><span class="o">.</span><span class="n">filesize</span><span class="p">)</span>

            <span class="n">shared_gflibrary</span> <span class="o">=</span> <span class="n">RawArray</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">gfs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

            <span class="n">work</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">gfs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">,</span> <span class="n">los_vectors</span><span class="p">,</span> <span class="n">odws</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">patchidx</span><span class="p">,</span> <span class="n">patch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="n">fault</span><span class="o">.</span><span class="n">get_all_patches</span><span class="p">(</span><span class="s1">&#39;geodetic&#39;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">var</span><span class="p">))]</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">parallel</span><span class="o">.</span><span class="n">paripool</span><span class="p">(</span>
                <span class="n">_process_patch_geodetic</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span>
                <span class="n">initializer</span><span class="o">=</span><span class="n">_init_shared</span><span class="p">,</span>
                <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">shared_gflibrary</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">nworkers</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="n">nworkers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># collect and store away</span>
                <span class="n">gfs</span><span class="o">.</span><span class="n">_gfmatrix</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span>
                    <span class="n">shared_gflibrary</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">gfs</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Storing geodetic linear GF Library ...&#39;</span><span class="p">)</span>

            <span class="n">gfs</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdirectory</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_process_patch_seismic</span><span class="p">(</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">gfs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">,</span> <span class="n">durations</span><span class="p">,</span> <span class="n">starttimes</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">patch</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">heart</span><span class="o">.</span><span class="n">physical_bounds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">patch</span><span class="o">.</span><span class="n">time</span> <span class="o">+=</span> <span class="n">gfs</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">time</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding event time to reference source time!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using reference source time ...&#39;</span><span class="p">)</span>

    <span class="n">source_patches_durations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Patch Number </span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">duration</span> <span class="ow">in</span> <span class="n">durations</span><span class="p">:</span>
        <span class="n">pcopy</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">pcopy</span><span class="o">.</span><span class="n">stf</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="n">source_patches_durations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcopy</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>

        <span class="n">traces</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">heart</span><span class="o">.</span><span class="n">seis_synthetics</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="n">source_patches_durations</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">],</span>
            <span class="n">arrival_taper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">wavename</span><span class="o">=</span><span class="n">gfs</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wave_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">filterer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">reference_taperer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>

        <span class="c1"># getting patch related arrival time for hypocenter</span>
        <span class="n">arrival_time</span> <span class="o">=</span> <span class="n">heart</span><span class="o">.</span><span class="n">get_phase_arrival_time</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">patch</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="n">wavename</span><span class="o">=</span><span class="n">gfs</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wave_config</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">ptmin</span> <span class="o">=</span> <span class="n">gfs</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wave_config</span><span class="o">.</span><span class="n">arrival_taper</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">arrival_time</span>
        <span class="n">gfs</span><span class="o">.</span><span class="n">set_patch_time</span><span class="p">(</span><span class="n">targetidx</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">patchidx</span><span class="o">=</span><span class="n">patchidx</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">ptmin</span><span class="p">)</span>

        <span class="c1"># getting event related arrival time valid for all patches</span>
        <span class="c1"># as common reference</span>
        <span class="n">arrival_time</span> <span class="o">=</span> <span class="n">heart</span><span class="o">.</span><span class="n">get_phase_arrival_time</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">gfs</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">event</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="n">wavename</span><span class="o">=</span><span class="n">gfs</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wave_config</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">ref_tmin</span> <span class="o">=</span> <span class="n">gfs</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wave_config</span><span class="o">.</span><span class="n">arrival_taper</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">arrival_time</span>
        <span class="n">gfs</span><span class="o">.</span><span class="n">set_patch_time</span><span class="p">(</span><span class="n">targetidx</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">patchidx</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">ref_tmin</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">starttime</span> <span class="ow">in</span> <span class="n">starttimes</span><span class="p">:</span>
            <span class="n">tmin</span> <span class="o">=</span> <span class="n">ref_tmin</span> <span class="o">-</span> <span class="n">starttime</span>

            <span class="n">synthetics_array</span> <span class="o">=</span> <span class="n">heart</span><span class="o">.</span><span class="n">taper_filter_traces</span><span class="p">(</span>
                <span class="n">traces</span><span class="o">=</span><span class="n">traces</span><span class="p">,</span>
                <span class="n">arrival_taper</span><span class="o">=</span><span class="n">gfs</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wave_config</span><span class="o">.</span><span class="n">arrival_taper</span><span class="p">,</span>
                <span class="n">filterer</span><span class="o">=</span><span class="n">gfs</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wave_config</span><span class="o">.</span><span class="n">filterer</span><span class="p">,</span>
                <span class="n">tmins</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">durations</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">tmin</span><span class="p">,</span>
                <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">)</span>

            <span class="n">gfs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="n">entries</span><span class="o">=</span><span class="n">synthetics_array</span><span class="p">,</span>
                <span class="n">targetidx</span><span class="o">=</span><span class="n">j</span><span class="p">,</span>
                <span class="n">patchidx</span><span class="o">=</span><span class="n">patchidx</span><span class="p">,</span>
                <span class="n">durations</span><span class="o">=</span><span class="n">durations</span><span class="p">,</span>
                <span class="n">starttimes</span><span class="o">=</span><span class="n">starttime</span><span class="p">)</span>


<div class="viewcode-block" id="seis_construct_gf_linear"><a class="viewcode-back" href="../api.html#ffi.seis_construct_gf_linear">[docs]</a><span class="k">def</span> <span class="nf">seis_construct_gf_linear</span><span class="p">(</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">fault</span><span class="p">,</span> <span class="n">durations_prior</span><span class="p">,</span> <span class="n">velocities_prior</span><span class="p">,</span>
        <span class="n">varnames</span><span class="p">,</span> <span class="n">wavemap</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">nworkers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">starttime_sampling</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">duration_sampling</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">outdirectory</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create seismic Greens Function matrix for defined source geometry</span>
<span class="sd">    by convolution of the GFs with the source time function (STF).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">        main path to directory containing the different Greensfunction stores</span>
<span class="sd">    targets : list</span>
<span class="sd">        of pyrocko target objects for respective phase to compute</span>
<span class="sd">    wavemap : :class:`heart.WaveformMapping`</span>
<span class="sd">        configuration parameters for handeling seismic data around Phase</span>
<span class="sd">    fault : :class:`FaultGeometry`</span>
<span class="sd">        fault object that may comprise of several sub-faults. thus forming a</span>
<span class="sd">        complex fault-geometry</span>
<span class="sd">    durations_prior : :class:`heart.Parameter`</span>
<span class="sd">        prior of durations of the STF for each patch to convolve</span>
<span class="sd">    duration_sampling : float</span>
<span class="sd">        incremental step size for precalculation of duration GFs</span>
<span class="sd">    velocities_prior : :class:`heart.Parameter`</span>
<span class="sd">        rupture velocity of earthquake prior</span>
<span class="sd">    starttime_sampling : float</span>
<span class="sd">        incremental step size for precalculation of startime GFs</span>
<span class="sd">    sample_rate : float</span>
<span class="sd">        sample rate of synthetic traces to produce,</span>
<span class="sd">        related to non-linear GF store</span>
<span class="sd">    outpath : str</span>
<span class="sd">        directory for storage</span>
<span class="sd">    force : boolean</span>
<span class="sd">        flag to overwrite existing linear GF Library</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get starttimes for hypocenter at corner of fault</span>

    <span class="n">start_times</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_subfault_starttimes</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rupture_velocities</span><span class="o">=</span><span class="n">velocities_prior</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span>
        <span class="n">nuc_dip_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nuc_strike_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">starttimeidxs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">start_times</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">starttime_sampling</span><span class="p">)))</span>
    <span class="n">starttimes</span> <span class="o">=</span> <span class="n">starttimeidxs</span> <span class="o">*</span> <span class="n">starttime_sampling</span>

    <span class="n">ndurations</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">error_not_whole</span><span class="p">((</span>
        <span class="p">(</span><span class="n">durations_prior</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span>
         <span class="n">durations_prior</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">duration_sampling</span><span class="p">),</span>
        <span class="n">errstr</span><span class="o">=</span><span class="s1">&#39;ndurations&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">durations</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
        <span class="n">durations_prior</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">durations_prior</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
        <span class="n">ndurations</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Calculating GFs for starttimes: </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> durations: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">starttimes</span><span class="p">),</span> <span class="n">ut</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">durations</span><span class="p">)))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">%i</span><span class="s1"> workers ...&#39;</span> <span class="o">%</span> <span class="n">nworkers</span><span class="p">)</span>

    <span class="n">nstarttimes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">starttimes</span><span class="p">)</span>
    <span class="n">npatches</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">npatches</span>
    <span class="n">ntargets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavemap</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">nsamples</span> <span class="o">=</span> <span class="n">wavemap</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">arrival_taper</span><span class="o">.</span><span class="n">nsamples</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;For slip component: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">)</span>

        <span class="n">gfl_config</span> <span class="o">=</span> <span class="n">SeismicGFLibraryConfig</span><span class="p">(</span>
            <span class="n">component</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
            <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
            <span class="n">duration_sampling</span><span class="o">=</span><span class="n">duration_sampling</span><span class="p">,</span>
            <span class="n">starttime_sampling</span><span class="o">=</span><span class="n">starttime_sampling</span><span class="p">,</span>
            <span class="n">wave_config</span><span class="o">=</span><span class="n">wavemap</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">dimensions</span><span class="o">=</span><span class="p">(</span><span class="n">ntargets</span><span class="p">,</span> <span class="n">npatches</span><span class="p">,</span> <span class="n">ndurations</span><span class="p">,</span> <span class="n">nstarttimes</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span>
            <span class="n">starttime_min</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">starttimes</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
            <span class="n">duration_min</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">durations</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>

        <span class="n">gfs</span> <span class="o">=</span> <span class="n">SeismicGFLibrary</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">gfl_config</span><span class="p">)</span>

        <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdirectory</span><span class="p">,</span> <span class="n">gfs</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.npz&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Library exists: </span><span class="si">%s</span><span class="s1">. &#39;</span>
                <span class="s1">&#39;Please use --force to override!&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nworkers</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">allocate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">allocate</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">gfs</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span>
                <span class="n">ntargets</span><span class="p">,</span> <span class="n">npatches</span><span class="p">,</span> <span class="n">ndurations</span><span class="p">,</span>
                <span class="n">nstarttimes</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">allocate</span><span class="o">=</span><span class="n">allocate</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Setting up Green&#39;s Function Library: </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">gfs</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>

            <span class="n">parallel</span><span class="o">.</span><span class="n">check_available_memory</span><span class="p">(</span><span class="n">gfs</span><span class="o">.</span><span class="n">filesize</span><span class="p">)</span>

            <span class="n">shared_gflibrary</span> <span class="o">=</span> <span class="n">RawArray</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">gfs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">shared_times</span> <span class="o">=</span> <span class="n">RawArray</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">gfs</span><span class="o">.</span><span class="n">ntargets</span> <span class="o">*</span> <span class="p">(</span><span class="n">gfs</span><span class="o">.</span><span class="n">npatches</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">work</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">gfs</span><span class="p">,</span> <span class="n">wavemap</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span>
                    <span class="n">patch</span><span class="p">,</span> <span class="n">patchidx</span><span class="p">,</span> <span class="n">durations</span><span class="p">,</span> <span class="n">starttimes</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">patchidx</span><span class="p">,</span> <span class="n">patch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="n">fault</span><span class="o">.</span><span class="n">get_all_patches</span><span class="p">(</span><span class="s1">&#39;seismic&#39;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">var</span><span class="p">))]</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">parallel</span><span class="o">.</span><span class="n">paripool</span><span class="p">(</span>
                <span class="n">_process_patch_seismic</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span>
                <span class="n">initializer</span><span class="o">=</span><span class="n">_init_shared</span><span class="p">,</span>
                <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">shared_gflibrary</span><span class="p">,</span> <span class="n">shared_times</span><span class="p">),</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">nworkers</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="n">nworkers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># collect and store away</span>
                <span class="n">gfs</span><span class="o">.</span><span class="n">_gfmatrix</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span>
                    <span class="n">shared_gflibrary</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">gfs</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
                <span class="n">gfs</span><span class="o">.</span><span class="n">_tmins</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">shared_times</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">gfs</span><span class="o">.</span><span class="n">ntargets</span><span class="p">,</span> <span class="n">gfs</span><span class="o">.</span><span class="n">npatches</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Storing seismic linear GF Library ...&#39;</span><span class="p">)</span>

            <span class="n">gfs</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdirectory</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">gfs</span></div>


<span class="k">def</span> <span class="nf">_patch_locations</span><span class="p">(</span><span class="n">n_patch_strike</span><span class="p">,</span> <span class="n">n_patch_dip</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines from patch locations the neighboring patches</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_patch_strike : int</span>
<span class="sd">        number of patches in strike direction</span>
<span class="sd">    n_patch_dip : int</span>
<span class="sd">        number of patches in dip direction</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.Ndarray`</span>
<span class="sd">        (n_patch_strike + n_patch_dip) x 4</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_patches</span> <span class="o">=</span> <span class="n">n_patch_dip</span> <span class="o">*</span> <span class="n">n_patch_strike</span>

    <span class="n">zeros_strike</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_patch_strike</span><span class="p">)</span>
    <span class="n">zeros_dip</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_patch_dip</span><span class="p">)</span>

    <span class="n">dmat</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_patches</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">dmat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_patch_strike</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeros_strike</span>
    <span class="n">dmat</span><span class="p">[</span><span class="o">-</span><span class="n">n_patch_strike</span><span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeros_strike</span>
    <span class="n">dmat</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">n_patch_strike</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeros_dip</span>
    <span class="n">dmat</span><span class="p">[</span><span class="n">n_patch_strike</span> <span class="o">-</span> <span class="mi">1</span><span class="p">::</span><span class="n">n_patch_strike</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeros_dip</span>
    <span class="k">return</span> <span class="n">dmat</span>


<div class="viewcode-block" id="get_smoothing_operator"><a class="viewcode-back" href="../api.html#ffi.get_smoothing_operator">[docs]</a><span class="k">def</span> <span class="nf">get_smoothing_operator</span><span class="p">(</span>
        <span class="n">n_patch_strike</span><span class="p">,</span> <span class="n">n_patch_dip</span><span class="p">,</span> <span class="n">patch_size_strike</span><span class="p">,</span> <span class="n">patch_size_dip</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get second order Laplacian smoothing operator.</span>

<span class="sd">    This is beeing used to smooth the slip-distribution in the optimization.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_patch_strike : int</span>
<span class="sd">        number of patches in strike direction</span>
<span class="sd">    n_patch_dip : int</span>
<span class="sd">        number of patches in dip direction</span>
<span class="sd">    patch_size_strike : float</span>
<span class="sd">        size of patches along strike-direction [km]</span>
<span class="sd">    patch_size_dip : float</span>
<span class="sd">        size of patches along dip-direction [km]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.Ndarray`</span>
<span class="sd">        (n_patch_strike + n_patch_dip) x (n_patch_strike + n_patch_dip)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_patches</span> <span class="o">=</span> <span class="n">n_patch_dip</span> <span class="o">*</span> <span class="n">n_patch_strike</span>

    <span class="n">dmat</span> <span class="o">=</span> <span class="n">_patch_locations</span><span class="p">(</span>
        <span class="n">n_patch_strike</span><span class="o">=</span><span class="n">n_patch_strike</span><span class="p">,</span> <span class="n">n_patch_dip</span><span class="o">=</span><span class="n">n_patch_dip</span><span class="p">)</span>

    <span class="n">smooth_op</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_patches</span><span class="p">,</span> <span class="n">n_patches</span><span class="p">))</span>

    <span class="n">delta_l_dip</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">patch_size_dip</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">delta_l_strike</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">patch_size_strike</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">deltas</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">delta_l_dip</span><span class="p">,</span> <span class="n">delta_l_dip</span><span class="p">,</span> <span class="n">delta_l_strike</span><span class="p">,</span> <span class="n">delta_l_strike</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_patches</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">dmat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">smooth_op</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">flags</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">smooth_op</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">n_patch_strike</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_l_dip</span>
        <span class="k">if</span> <span class="n">flags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">smooth_op</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n_patch_strike</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_l_dip</span>
        <span class="k">if</span> <span class="n">flags</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">smooth_op</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_l_strike</span>
        <span class="k">if</span> <span class="n">flags</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">smooth_op</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_l_strike</span>

    <span class="k">return</span> <span class="n">smooth_op</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    
<h3><a href="../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../short_installation.html">Short Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Detailed Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../updating.html">Updating beat</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started with BEAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Scenarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
    &nbsp;
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Hannes Vasyura-Bathke.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.6.
    </div>
  </body>
</html>